"use strict";var debugMode=0;function convertDivToP(){var e=document.getSelection(),t=e.getRangeAt(0);if(isSelectionInMarko()&&"div"===t.startContainer.localName){var n,i=document.createElement("p"),o=t.startContainer;for(t.setStartAfter(o);n=o.firstChild;)i.appendChild(n);o.parentNode.removeChild(o),t.insertNode(i),t.setStart(i,0),e.removeAllRanges(),e.addRange(t)}}debugMode||($(".marko-form-submit-textarea").css("display","none"),$(".marko-test-button-container").css("display","none")),updatePreview(),$(".marko-editor").on("keyup",function(e){updatePreview();var t=window.getSelection();t.getRangeAt(0);t.isCollapsed?$(".tool").removeClass("active"):updateSelectionStatus()}),$(".marko-editor").on("keydown",function(e){var t=e.which;document.getSelection().getRangeAt(0);if(""===$(this).html()){var n=document.createElement("p");n.innerHTML="<br />",document.getElementsByClassName("marko-editor")[0].appendChild(n);var i=window.getSelection(),o=document.createRange();o.setStart(n,0),o.setEnd(n,0),i.removeAllRanges(),i.addRange(o)}switch(t){case 8:case 86:case 13:setTimeout(function(){convertDivToP()},0)}}),$(".insert-img").on("click",function(){$(".marko-editor").append('<img src="/assets/images/jhm-logo.svg" />')}),$(".make-it-bold").on("click",function(){textTransformation("b")}),$(".marko").on("mousedown",function(){document.getElementsByClassName("marko-editor")[0].normalize(),$(window).on("mouseup",function(){setTimeout(function(){updateSelectionStatus()},0)})}),$(".marko-editor").on("click",function(){$(".subtool-container").removeClass("pop-up active")}),$(".tool").on("click",function(){$(".subtool-container").removeClass("pop-up active")}),$(".tool.bold-union").on("click",function(){window.getSelection().isCollapsed||(globalHasCommonStyles&&isElmementInArray(globalCommonStylesTags,"strong")||isElmementInArray(globalCommonStylesTags,"b")?(textRestoration("strong"),$(".bold-union").removeClass("active")):itmotnTT("strong"))}),$(".tool.italics-union").on("click",function(){window.getSelection().isCollapsed||(globalHasCommonStyles&&isElmementInArray(globalCommonStylesTags,"em")||isElmementInArray(globalCommonStylesTags,"i")?(textRestoration("em"),$(".italics-union").removeClass("active")):itmotnTT("em"))}),$(".tool.underline-union").on("click",function(){window.getSelection().isCollapsed||(globalHasCommonStyles&&isElmementInArray(globalCommonStylesTags,"u")?(textRestoration("u"),$(".underline-union").removeClass("active")):itmotnTT("underline"))}),$(".tool.link-union").on("click",function(){window.getSelection().isCollapsed||(globalHasCommonStyles&&isElmementInArray(globalCommonStylesTags,"a")?(textRestoration("a"),$(".underline-union").removeClass("active")):linking())}),document.querySelector(".tool.list-union").addEventListener("click",function(){listing()}),document.querySelector(".tool.align-left").addEventListener("click",function(){align("left")}),document.querySelector(".tool.align-center").addEventListener("click",function(){align("center")}),document.querySelector(".tool.align-right").addEventListener("click",function(){align("right")}),$(".tool.heading").on("click",function(){$(".subtool-container.heading").addClass("active"),setTimeout(function(){$(".subtool-container.heading").addClass("pop-up")},0)});var subTools=document.querySelectorAll(".subtool");function updatePreview(){$(".marko-submit").val($(".marko-editor").html())}function cleanHTML(e){e=void 0!==e?e:"whole";var t=window.getSelection(),n='<span id="mk-cr-s"></span>',i='<span id="mk-cr-e"></span>';if(t.rangeCount>0)var o=t.getRangeAt(0);!o||document.querySelector("#mk-cr-s")||document.querySelector("#mk-cr-e")||recordSelection(o);var a=$(".marko-editor").html();if("whole"===e)a=$(".marko-editor").html();else if("selection"===e){var r=$(".marko-editor").html().split(n),l=r[1].split(i);r[1]=l[0],r[2]=l[1],a=r[1]}var s=/<\/(strong|em|u)><\1>/gi;a=a.replace(s,""),s=/<b>(.*?)<\/b>/gi,a=a.replace(s,"<strong>$1</strong>"),s=/<i>(.*?)<\/i>/gi,a=a.replace(s,"<em>$1</em>"),s=/<(strong|em|u|b|i|span) *.*?><\/\1>/gi,a=a.replace(s,""),s=/<a( href=".*?")*><\/a>/gi,a=a.replace(s,""),s=/<(strong|em|u)><span id="(mk-cr-s|mk-cr-e)"><\/span><\/\1>/gi,a=(a=a.replace(s,'<span id="$2"></span>')).replace("<strong></strong>",""),"selection"===e&&(a=r[0]+n+a+i+r[2]),$(".marko-editor").html(a),revertSelection(),updatePreview(),updateSelectionStatus()}function isSelectionInMarko(){var e=window.getSelection();if(0===e.rangeCount)return!1;for(var t=e.getRangeAt(0),n=t.startContainer,i=t.endContainer,o=n.parentElement,a=!1,r=!1;o&&!a;)"marko-editor"===o.className?a=!0:o=o.parentElement;for(o=i.parentElement;o&&!r;)"marko-editor"===o.className?r=!0:o=o.parentElement;return!(!a||!r)}subTools.forEach(function(e,t){e.addEventListener("click",function(){document.querySelector(".subtool-container").classList.remove("pop-up"),document.querySelector(".subtool-container").classList.remove("active")})}),$(".subtool.heading1").on("click",function(){heading(1)}),$(".subtool.heading2").on("click",function(){heading(2)}),$(".subtool.heading3").on("click",function(){heading(3)}),$(".subtool.remove-heading").on("click",function(){heading(0)}),$(".marko-popup-bg").on("click",function(){$(".marko-popup-container").addClass("hidden")}),$(".marko-editor").on("click","a",function(e){}),$("#clean").on("click",function(){cleanHTML()}),$("#getsel").on("click",function(){var e=window.getSelection().getRangeAt(0);console.log(e.startContainer),console.log(e.endContainer),console.log(e)}),$("#convert").on("click",function(){var e=$(".marko-form-submit-textarea").val();$(".marko-editor").html(e)}),$("#htmler").on("click",function(){$(".marko-form-submit-textarea").val($(".marko-editor").html())});var globalHasCommonStyles=!1,globalCommonStylesTags=[];function updateSelectionStatus(){if(!isSelectionInMarko())return globalHasCommonStyles=!1,globalCommonStylesTags=[],void $(".tool").removeClass("active");var e=window.getSelection();if(0!==e.rangeCount){if(e.isCollapsed)return globalHasCommonStyles=!1,globalCommonStylesTags=[],void $(".tool").removeClass("active");var t=e.getRangeAt(0),n=[],i=t.startContainer,o=t.endContainer,a=i.parentNode,r=[],l=!0;if($(".tool").removeClass("active"),t.startOffset===i.textContent.length)for(;;){if(i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else for(;;)if((i=i.parentNode).nextSibling){i=i.nextSibling;break}if(void 0===i.localName)break}for(var s,d=i;s=getTagName(d),!isMotherTag(d);)n.push(s),d=d.parentNode;for(a=i;a!==o;){if(a.firstChild)a=a.firstChild;else if(a.nextSibling)a=a.nextSibling;else for(;;)if((a=a.parentNode).nextSibling){a=a.nextSibling;break}if(void 0===a.localName&&"div"!==a.parentNode.localName){for(d=a;s=getTagName(d=d.parentNode),!isMotherTag(d);)-1!==n.indexOf(s)&&r.push(s);if(n=r,r=[],0===n.length){l=!1;break}}}if(l){globalHasCommonStyles=!0,globalCommonStylesTags=n;for(var c=0;c<globalCommonStylesTags.length;c+=1)"strong"===globalCommonStylesTags[c]?$(".bold-union").addClass("active"):"em"===globalCommonStylesTags[c]?$(".italics-union").addClass("active"):"underline"===globalCommonStylesTags[c]?$(".underline-union").addClass("active"):"a"===globalCommonStylesTags[c]&&$(".link-union").addClass("active")}else globalHasCommonStyles=!1,globalCommonStylesTags=[]}}function recordSelection(e){var t=window.getSelection(),n=document.createElement("span");n.id="mk-cr-s";var i=document.createElement("span");i.id="mk-cr-e",t.collapseToStart(),t.getRangeAt(0).insertNode(n),t.removeAllRanges(),t.addRange(e),t.collapseToEnd(),t.getRangeAt(0).insertNode(i)}function revertSelection(){var e=window.getSelection(),t=document.querySelector("#mk-cr-s"),n=document.querySelector("#mk-cr-e"),i=document.createRange(),o=!1;if(t.nextSibling)for(var a=t.nextSibling;;){if(!a){o=!0;break}if(a.firstChild){if(void 0===a.firstChild.localName){i.setStart(a.firstChild,0);break}if("br"===a.firstChild.localName){i.setStartBefore(a.firstChild);break}a=a.nextSibling}else if(void 0===a.localName){if(0!==a.textContent.length){i.setStart(a,0);break}a.parentNode.removeChild(a)}else{if("br"===a.localName){i.setStartBefore(a);break}a=a.firstChild}}if(o&&t.previousSibling)for(var r=t.previousSibling;;){if(!r){i.setStartAfter(t);break}if(void 0===r.localName){if(0!==r.textContent.length){i.setStart(r,r.textContent.length);break}r=r.previousSibling}}if(n.previousSibling)if(void 0===(r=n.previousSibling).localName)i.setEnd(r,r.textContent.length);else for(;void 0!==r.localName;){if(!(r=r.lastChild)){i.setEndBefore(n);break}if(void 0===r.localName){i.setEnd(r,r.textContent.length);break}}else i.setEndBefore(n);t.parentNode.removeChild(t),n.parentNode.removeChild(n),e.removeAllRanges(),e.addRange(i)}function keepRange(){var e=window.getSelection(),t=document.createRange();if(e.rangeCount>0)var n=e.getRangeAt(0);if(n&&!document.querySelector("#mk-cr-s")&&!document.querySelector("#mk-cr-e")){e.collapseToStart();var i=document.createElement("div");i.innerHTML='<span id="mk-cr-s"></span><span id="mk-cr-e"></span>',e.collapseToStart(),e.getRangeAt(0).insertNode(i.firstChild),e.removeAllRanges(),e.addRange(n),e.collapseToEnd(),e.getRangeAt(0).insertNode(i.firstChild)}var o,a=document.querySelector("#mk-cr-s"),r=document.querySelector("#mk-cr-e");if(a.nextSibling)for(o=a.nextSibling;;){if(void 0===o.localName){t.setStart(o,0);break}if("br"===o.localName){t.setStartBefore(o);break}o=o.firstChild}else for(o=a.previousSibling;;){if(void 0===o.localName){t.setStart(o,o.textContent.length);break}o=o.lastChild}if(r.previousSibling)for(o=r.previousSibling;;){if(void 0===o.localName){t.setEnd(o,o.textContent.length);break}o=o.lastChild}else t.setEndBefore(r);e.removeAllRanges(),e.addRange(t),a.parentNode.removeChild(a),r.parentNode.removeChild(r)}function createList(e){isSelectionInMarko()&&(console.log(e),$(".marko-add-link-button").on("click",function(){console.log(e);var t=$(".marko-link-input").val();console.log(t),togglePopUp()}))}function togglePopUp(){var e=$(".marko-popup-container");e.hasClass("hidden")?e.removeClass("hidden"):e.addClass("hidden")}var motherTags=["p","ul","li","div","h1","h2","h3","h4","h5","h6","pre","body","html","aside","article","section","img"],childTags=["strong","b","em","i","u","span","a"];function isMotherTag(e){return null!==e&&-1!==motherTags.indexOf(e.nodeName.toLowerCase())}function isChildTag(e){return-1!==childTags.indexOf(e.nodeName.toLowerCase())}function isSameTag(e,t){if(null===e||null===t)return!1;if(3===e.nodeType||3===t.nodeType)return!1;var n=!1;return e.nodeName===t.nodeName?n=!0:"span"===e.nodeName.toLowerCase()&&"u"===t.nodeName.toLowerCase()?"underline"===e.style.textDecoration&&(n=!0):"u"===e.nodeName.toLowerCase()&&"span"===t.nodeName.toLowerCase()&&"underline"===t.style.textDecoration&&(n=!0),n}function getTagName(e){if(!e)return null;var t=e.nodeName.toLowerCase();return"strong"===t||"b"===t?"strong":"em"===t||"i"===t?"em":"u"===t||"span"===t&&"underline"===e.style.textDecoration?"underline":t}function mergeNodes(e,t){var n,i=window.getSelection(),o=document.createRange();for(i.removeAllRanges(),i.addRange(o),t.parentNode.removeChild(t);n=t.firstChild;)o.setStartAfter(e.lastChild),insertAndCleanNodesAtRange(o,n);return e}function insertAndCleanNodesAtRange(e,t){var n=window.getSelection();if(n.removeAllRanges(),n.addRange(e),e.insertNode(t),!isMotherTag(t)){for(var i=t.previousSibling;i;){if(0!==i.textContent.length){if(isSameTag(i,t)){t=mergeNodes(i,t);break}break}i.parentNode.removeChild(i),i=t.previousSibling}for(var o=t.nextSibling;o;){if(0!==o.textContent.length){if(isSameTag(t,o)){t=mergeNodes(t,o);break}break}o.parentNode.removeChild(o),o=t.nextSibling}return t}}function hasSameTagChildren(e){}function cleanSameTagChildren(e){var t=getTagName(e);if(e.innerHTML!==cleanTagFromHTML(e.innerHTML,t))for(var n,i=e.firstChild,o=document.createRange();!r;)if(isSameTag(e,i)){o.setStartBefore(i);var a=i;for(a.parentNode.removeChild(a);n=a.lastChild;)n=insertAndCleanNodesAtRange(o,n),o.setStartBefore(n),i=n}else if(i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else for(;;){if((i=i.parentNode)===e)var r=!0;if(i.nextSibling){i=i.nextSibling;break}}}function cleanTagFromHTML(e,t){switch(t){case"strong":e=(e=e.replace(/<strong ?.*?>([\s\S]*?)<\/strong>/gi,"$1")).replace(/<b ?.*?>([\s\S]*?)<\/b>/gi,"$1");break;case"em":e=(e=e.replace(/<em ?.*?>([\s\S]*?)<\/em>/gi,"$1")).replace(/<i ?.*?>([\s\S]*?)<\/i>/gi,"$1");break;case"underline":e=(e=e.replace(/<span ?.*?style=".*?text-decoration: ?underline.*?">([\s\S]*?)<\/span>/gi,"$1")).replace(/<u>([\s\S]*?)<\/u>/gi,"$1")}return e}function generateNode(e,t){var n;switch(e){case"strong":n=document.createElement("strong");break;case"em":n=document.createElement("em");break;case"underline":(n=document.createElement("span")).style.textDecoration="underline";break;case"a":(n=document.createElement("a")).href=t}return n}function itmotnTT(e,t,n){var i=document.getSelection();if(n&&(r=n,i.removeAllRanges(),i.addRange(r)),isSelectionInMarko()){var o,a,r=i.getRangeAt(0),l=r.startContainer,s=r.endContainer,d=r.startOffset,c=r.endOffset,g=l,f=s,m=d,u=c;if(3===l.nodeType&&d>0&&d<l.textContent.length){var p=l.textContent,C=document.createTextNode(p.slice(0,d)),S=document.createTextNode(p.slice(d));r.collapse(!0),r.setStartAfter(l),l.parentNode.removeChild(l),r.insertNode(C),r.setStartAfter(C),r.insertNode(S),g=S,m=0,l===s&&(f=g,u=c-d)}if(3===f.nodeType&&u<f.textContent.length&&u>0){p=f.textContent,C=document.createTextNode(p.slice(0,u)),S=document.createTextNode(p.slice(u));r.collapse(!0),r.setStartAfter(f),f.parentNode.removeChild(f),r.insertNode(C),r.setStartAfter(C),r.insertNode(S),f=C,u=C.textContent.length,l===s&&(g=f)}if(3===g.nodeType&&m<g.textContent.length)a=g;else for(var v=g;v!==f;){if(v.firstChild)v=v.firstChild;else if(v.nextSibling)v=v.nextSibling;else for(;;)if((v=v.parentNode).nextSibling){v=v.nextSibling;break}if(3===v.nodeType){a=v;break}}var h=document.createRange();for(i.removeAllRanges(),i.addRange(h);;)if(a.previousSibling){if(0!==a.previousSibling.textContent.length)break;a=a.previousSibling}else{if(!isChildTag(a.parentNode))break;a=a.parentNode}for(;;){var b=generateNode(e,t);if(h.setStartBefore(a),isMotherTag(a)){if(a===f)break;a=a.firstChild?a.firstChild:a.nextSibling}else{for(var k=!1;;){if(null===a){k=!0;break}if(a.contains(f)){if(a===f){k=!0,b.appendChild(a),insertAndCleanNodesAtRange(h,b),cleanSameTagChildren(b);break}for(o=a;o.lastChild;){if(o.lastChild===f){k=!0;break}o=o.lastChild,k=!1}if(k){b.appendChild(a),insertAndCleanNodesAtRange(h,b),cleanSameTagChildren(b);break}a=a.firstChild?a.firstChild:a.nextSibling,b.firstChild&&(insertAndCleanNodesAtRange(h,b),cleanSameTagChildren(b));break}o=a;var N=a.nextSibling;if(b.appendChild(o),null===(a=N)){for(cleanSameTagChildren(b=insertAndCleanNodesAtRange(h,b)),o=b;;){if(o.parentNode.nextSibling){a=o.parentNode.nextSibling;break}o=o.parentNode}break}}if(b.firstChild){o=b.parentNode;for(;!isMotherTag(o);){if(isSameTag(o,b)){var x;for(r.setStartAfter(b);x=b.firstChild;)r.insertNode(x),r.setStartAfter(x);b.parentNode.removeChild(b),!0;break}o=o.parentNode}if(k)break}}}i.removeAllRanges(),r.setStart(g,m),r.setEnd(f,u),i.addRange(r),updatePreview()}}function align(e){var t=window.getSelection();if(!(t.rangeCount<1)&&isSelectionInMarko())for(var n=t.getRangeAt(0),i=n.startContainer,o=n.endContainer,a=["p","h1","h2","h3","h4","h5","h6","div","pre","section","li"],r=i,l=[];;){if(3===r.nodeType)for(var s=r.parentNode;"marko-editor"!==s.className;){if(-1!==a.indexOf(s.nodeName.toLowerCase())){-1===l.indexOf(s)&&(l.push(s),s.style.textAlign="left"===e?"":e,""===s.getAttribute("style")&&s.removeAttribute("style"));break}s=s.parentNode}if(r===o)break;if(r.firstChild)r=r.firstChild;else if(r.nextSibling)r=r.nextSibling;else for(;;)if((r=r.parentNode).nextSibling){r=r.nextSibling;break}}}function heading(e){e=void 0!==e?e:1;var t=window.getSelection();if(!(t.rangeCount<1)&&isSelectionInMarko()){for(var n=t.getRangeAt(0),i=n.startContainer,o=n.endContainer,a=n.startOffset,r=n.endOffset,l=["p","h1","h2","h3","h4","h5","h6"],s=i,d=[];;){if(3===s.nodeType)for(var c=s.parentNode;"marko-editor"!==c.className;){if(-1!==l.indexOf(c.nodeName.toLowerCase())){if(-1===d.indexOf(c)){var g,f;for(f=0===e?document.createElement("p"):document.createElement("h"+e);g=c.firstChild;)f.appendChild(g);c.parentNode.replaceChild(f,c),d.push(f)}break}c=c.parentNode}if(s===o)break;if(s.firstChild)s=s.firstChild;else if(s.nextSibling)s=s.nextSibling;else for(;;)if((s=s.parentNode).nextSibling){s=s.nextSibling;break}}n.setStart(i,a),n.setEnd(o,r),t.removeAllRanges(),t.addRange(n),updatePreview()}}function listing(){var e=window.getSelection();if(!(e.rangeCount<1)&&isSelectionInMarko()){for(var t,n=e.getRangeAt(0),i=n.startContainer,o=n.endContainer,a=n.startOffset,r=n.endOffset,l=["p","h1","h2","h3","h4","h5","h6"],s=i,d=[];;){if(3===s.nodeType)for(var c=s.parentNode;"marko-editor"!==c.className;){if(-1!==l.indexOf(c.nodeName.toLowerCase())){-1===d.indexOf(c)&&d.push(c);break}c=c.parentNode}if(s===o)break;if(s.firstChild)s=s.firstChild;else if(s.nextSibling)s=s.nextSibling;else for(;;)if((s=s.parentNode).nextSibling){s=s.nextSibling;break}}if(d.length>0){for(var g=document.createElement("ul"),f=0;f<d.length;f+=1){for(var m=document.createElement("li");t=d[f].firstChild;)m.appendChild(t);g.appendChild(m)}d[0].parentNode.replaceChild(g,d[0]);for(f=1;f<d.length;f+=1)d[f].parentNode.removeChild(d[f])}n.setStart(i,a),n.setEnd(o,r),e.removeAllRanges(),e.addRange(n),updatePreview()}}function linking(){var e=window.getSelection().getRangeAt(0),t=e.toString();document.getElementsByClassName("marko-link-target")[0].innerText=t,$(".marko-link-option-container").data("target-range",e),togglePopUp()}function isCaretStart(){var e=window.getSelection();if(isSelectionInMarko())e.getRangeAt(0)}function isCaretEnd(){}function tagTransformationCompact(e){var t,n=window.getSelection().getRangeAt(0),i=n.startContainer;n.endContainer,n.startOffset,n.endOffset;recordSelection(n);var o=document.querySelector("#mk-cr-s"),a=document.querySelector("#mk-cr-e");t=i;for(var r=!1,l=o;;){if((t=l)===a&&(r=!0),l.firstChild)l=l.firstChild;else if(l.nextSibling)l=l.nextSibling;else for(;;)if((l=l.parentNode).nextSibling){l=l.nextSibling;break}if(void 0===t.localName&&0!==t.textContent.length){for(var s=!1,d=t.parentElement;"marko-editor"!==d.className;){if(d.localName===e){s=!0;break}d=d.parentElement}if(!s){var c,g="<"+e+">",f="</"+e+">",m=document.createElement("div"),u=t.textContent;for(m.innerHTML=g+u+f,n.collapse(!0),n.setStartAfter(t),t.parentNode.removeChild(t);c=m.firstChild;)n.insertNode(c),n.setStartAfter(c)}}if(t=l,r)break}revertSelection()}function tagTransformation(e){var t,n,i,o,a,r=window.getSelection(),l=r.getRangeAt(0),s=l.startContainer,d=l.endContainer,c=l.startOffset,g=l.endOffset;t=s;for(var f=!1,m=s;;){if((t=m)===d&&(f=!0),m.firstChild)m=m.firstChild;else if(m.nextSibling)m=m.nextSibling;else for(;;)if((m=m.parentNode).nextSibling){m=m.nextSibling;break}if(void 0===t.localName){for(var u=!1,p=t.parentElement;"marko-editor"!==p.className;){if(p.localName===e){u=!0;break}p=p.parentElement}if(!u){var C="<"+e+">",S="</"+e+">",v=document.createElement("div"),h=t.textContent;if(s===d)for(v.innerHTML=h.slice(0,c)+C+h.slice(c,g)+S+h.slice(g),l.collapse(!0),l.setStartAfter(t),t.parentNode.removeChild(t);b=v.firstChild;)b.localName===e&&(n=b.firstChild,o=0,i=b.firstChild,a=b.textContent.length),l.insertNode(b),l.setStartAfter(b);else if(t===s&&s.textContent.length>c){for(v.innerHTML=h.slice(0,c)+C+h.slice(c)+S,l.collapse(!0),l.setStartAfter(t),t.parentNode.removeChild(t);b=v.firstChild;)b.localName===e&&(n=b.firstChild,o=0),l.insertNode(b),l.setStartAfter(b)}else if(t===d){for(v.innerHTML=C+h.slice(0,g)+S+h.slice(g),l.collapse(!0),l.setStartAfter(t),t.parentNode.removeChild(t);b=v.firstChild;)b.localName===e&&(i=b.firstChild,a=b.textContent.length),l.insertNode(b),l.setStartAfter(b)}else{var b;for(v.innerHTML=C+h+S,l.collapse(!0),l.setStartAfter(t),t.parentNode.removeChild(t);b=v.firstChild;)l.insertNode(b),l.setStartAfter(b)}}}if(t=m,f)break}var k=document.createRange();n?k.setStart(n,o):k.setStart(s,c),i?k.setEnd(i,a):k.setEnd(d,g),r.removeAllRanges(),r.addRange(k),cleanHTML("selection")}function htmlTransformation(e,t,n){var i=window.getSelection(),o=t||i.getRangeAt(0),a="<"+e+">",r="</"+e+">",l=new RegExp("<"+e+" *.*?>","ig"),s="</"+e+">";"u"===e&&(a='<span style="text-decoration:underline;">',r="</span>",l=new RegExp('<span .*?(style=".*?text-decoration: *underline;.*?").*?>'),s="</span>"),recordSelection(o);var d='<span id="mk-cr-s"></span>',c='<span id="mk-cr-e"></span>',g=$(".marko-editor").html().split(d),f=g[1].split(c);g[1]=f[0],g[2]=f[1];var m,u,p=g[1],C=0,S=Number.MAX_VALUE;(m=p.match(l))&&(C=m.length,S=p.search(l));var v=0,h=Number.MAX_VALUE;(u=p.match(r))&&(v=u.length,h=p.search("</"+e+">"));var b=new RegExp("<"+e+" *.*?>|"+s,"ig");p=p.replace(b,""),0===C&&0===v?p=a+p+r:C===v?p=S<h?a+p+r:p:S<h?p=a+p:p+=r,$(".marko-editor").html(g[0]+d+p+c+g[2]),cleanHTML("selection")}function htmlRestoration(e){if(cleanHTML(),isSelectionInMarko()){var t=window.getSelection(),n=t.getRangeAt(0),i=document.createElement("div");i.innerHTML='<span id="mk-cr-s"></span><span id="mk-cr-e"></span>',t.collapseToStart(),t.getRangeAt(0).insertNode(i.firstChild),t.removeAllRanges(),t.addRange(n),t.collapseToEnd(),t.getRangeAt(0).insertNode(i.firstChild);var o=$(".marko-editor").html(),a=o.split('<span id="mk-cr-s"></span>'),r=a[1].split('<span id="mk-cr-e"></span>');a[1]=r[0],a[2]=r[1];var l=a[1],s=new RegExp("<"+e+">|</"+e+">","ig");l="</"+e+'><span id="mk-cr-s"></span>'+(l=l.replace(s,""))+'<span id="mk-cr-e"></span>',document.querySelector("#mk-cr-e").previousSibling&&(l=l+"<"+e+">"),o=a[0]+l+a[2],$(".marko-editor").html(o),cleanHTML(),updatePreview(),updateSelectionStatus()}}function textTransformation(e){var t=window.getSelection(),n=t.getRangeAt(0),i=document.createRange(),o=n.startContainer,a=n.endContainer,r=n.startOffset,l=n.endOffset;if(i.setStart(o,r),i.setEnd(a,l),t.isCollapsed)return t.removeAllRanges(),void t.addRange(n);var s,d,c,g,f,m=!1,u=o,p=document.createElement("div");for(g=o;"p"!==g.localName;){if(g.localName===e){!0;break}g=g.parentNode}for(;!m;){if(d=!1,c=!1,u===a&&(m=!0),void 0===u.localName&&"div"!==u.parentNode.localName){for(g=u.parentNode;"p"!==g.localName;){if(g.localName===e){d=!0;break}g=g.parentNode}d||(s=u,c=!0)}if(u.firstChild)u=u.firstChild;else if(u.nextSibling)u=u.nextSibling;else for(;;)if((u=u.parentNode).nextSibling){u=u.nextSibling;break}if(c){if(f=s.textContent,s===o&&s===a)for(p.innerHTML=f.slice(0,r)+"<"+e+">"+f.slice(r,l)+"</"+e+">"+f.slice(l),g=p.firstChild;g;)g.localName===e&&(o=g,a=g),g=g.nextSibling;else if(s===o)for(p.innerHTML=f.slice(0,r)+"<"+e+">"+f.slice(r)+"</"+e+">",g=p.firstChild;g;)g.localName===e&&(o=g),g=g.nextSibling;else if(s===a)for(p.innerHTML="<"+e+">"+f.slice(0,l)+"</"+e+">"+f.slice(l),g=p.firstChild;g;)g.localName===e&&(a=g),g=g.nextSibling;else p.innerHTML="<"+e+">"+f+"</"+e+">";for(n.collapse(!0),n.setStartBefore(s),s.parentNode.removeChild(s);g=p.firstChild;)n.insertNode(g),n.setStartAfter(g),g===o&&i.setStart(g.firstChild,0),g===a&&i.setEnd(g.firstChild,g.firstChild.textContent.length)}}t.removeAllRanges(),t.addRange(i)}function textRestoration(e){var t=window.getSelection(),n=t.getRangeAt(0),i=document.createRange();i.setStart(n.startContainer,n.startOffset),i.setEnd(n.endContainer,n.endOffset);var o=[e];if("strong"===e?o.push("b"):"em"===e?o.push("i"):"underline"===e&&o.push("u"),t.isCollapsed)return t.removeAllRanges(),void t.addRange(n);for(var a,r,l=n.startContainer,s=l,d=n.endContainer,c=n.startOffset,g=n.endOffset,f=!1,m=!1,u=[],p=[];!f;){if(s===d&&(f=!0),s===l){for(var C=s,S=[];"marko-editor"!==C.className;)C=C.parentNode,-1!==o.indexOf(C.localName)&&S.push(C);for(var v=S.length-1,h=0;v>=0;v-=1,h+=1)u[h]=S[v]}if(-1!==o.indexOf(s.localName)&&""!==s.textContent&&u.push(s),void 0===s.localName&&p.push(s),s.firstChild)s=s.firstChild;else if(s.nextSibling)s=s.nextSibling;else{for(;!s.parentNode.nextSibling;)s=s.parentNode;s=s.parentNode.nextSibling}if(m&&(a.parentNode.removeChild(a),m=!1),f)break}var b;for(document.createElement("div"),v=0;v<u.length;v+=1){r=u[v],n.collapse(!0),n.setStartBefore(r),s=r,f=!1,m=!1;for(var k,N=document.createElement("div");!f;){if(void 0===s.localName&&(s===d&&g<d.textContent.length||s===l&&c>0||!isElmementInArray(p,s))&&(a=s,m=!0),s.firstChild)s=s.firstChild;else if(s.nextSibling)s=s.nextSibling;else for(;;){if((s=s.parentNode)===r){f=!0;break}if(s.nextSibling){s=s.nextSibling;break}}if(m){k=a.textContent,l===a&&d===a?(c>0&&(N.innerHTML+="<"+e+">"+k.slice(0,c)+"</"+e+">"),N.innerHTML+=k.slice(c,g),g<k.length&&(N.innerHTML+="<"+e+">"+k.slice(g)+"</"+e+">"),d=l=c>0?N.firstChild.nextSibling:N.firstChild,c=0,g=l.textContent.length):a===d?(N.innerHTML=k.slice(0,g)+"<"+e+">"+k.slice(g)+"</"+e+">",g=(d=N.firstChild).textContent.length):a===l?(N.innerHTML="<"+e+">"+k.slice(0,c)+"</"+e+">"+k.slice(c),l=N.firstChild.nextSibling,c=0):isElmementInArray(p,a)||(N.innerHTML="<"+e+">"+k+"</"+e+">"),n.setStart(a,0),a.parentNode.removeChild(a);for(;b=N.firstChild;)n.insertNode(b),n.setStartAfter(b);m=!1}}for(n.setStartBefore(r);b=r.firstChild;)n.insertNode(b),n.setStartAfter(b);r.parentNode.removeChild(r)}n.setStartBefore(l),l.parentNode.removeChild(l),n.insertNode(l),i.setStart(l,c),i.setEnd(d,g),t.removeAllRanges(),t.addRange(i),updateSelectionStatus(),updatePreview()}function isElmementInArray(e,t){for(var n=0;n<e.length;n+=1)if(e[n]===t)return!0;return!1}function startNodeToEndNode(){var e=window.getSelection().getRangeAt(0),t=e.startContainer,n=e.endContainer,i=t;console.log(i);do{if(i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else{for(;!i.parentNode.nextSibling;)i=i.parentNode;i=i.parentNode.nextSibling}void 0===i.localName&&console.log(i)}while(i!==n)}$("#test").on("click",function(){var e=document.querySelector(".marko-editor").firstChild.firstChild.firstChild;console.log(e.tagName),console.log(e.nodeName)}),$(".marko-add-link-button").on("click",function(){var e=$(".marko-link-input").val(),t=$(".marko-link-option-container").data("target-range");$(".marko-link-input").val(""),togglePopUp(),itmotnTT("a",e,t)}),$(".marko-button-cancel").on("click",function(){$(".marko-link-input").val(""),togglePopUp()}),$(".get-ranges").on("click",function(){var e=window.getSelection();console.log(e.getRangeAt(0))}),$(".start-to-end").on("click",function(){startNodeToEndNode()}),$(".get-all-selection").on("click",function(){var e=window.getSelection().getRangeAt(0);console.log(e.startContainer),console.log(e.endContainer),e.setStartAfter(e.startContainer)}),$(".get-selection").on("click",function(){var e=window.getSelection();$(".console-div").append(e);var t=e.getRangeAt(0),n=document.createElement("div");n.innerHTML="<span></span>",document.createDocumentFragment().appendChild(n.firstChild);t.cloneContents(),t.startContainer.parentElement.innerHTML;console.log(t.startContainer),console.log(t.startOffset),console.log(t.endContainer),console.log(t.endOffset)}),$(".previous-sibling").on("click",function(){var e=window.getSelection().getRangeAt(0);console.log(e.startContainer.previousSibling)}),$(".next-sibling").on("click",function(){var e=window.getSelection().getRangeAt(0);console.log(e.startContainer.nextSibling)});